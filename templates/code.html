<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EpochFolio - Smart Resume Screening</title>
    <style>
        /* Your existing CSS styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex; /* Use flexbox for body to center content */
            justify-content: center;
            align-items: center;
            padding: 20px; /* Add some padding around the container */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0; /* Remove padding here as it's on the body now */
            min-height: auto; /* Allow height to adjust based on content */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%; /* Ensure container takes full width up to max-width */
        }

        .page {
            display: none;
            background: rgba(255, 255, 255, 0.95); /* Slightly transparent white */
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); /* Stronger shadow */
            padding: 40px;
            width: 100%;
            max-width: 600px;
            animation: fadeIn 0.5s ease-in;
            position: relative;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(5px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
        }

        #dashboard.page {
            max-width: 1500px;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            animation: slideIn 1s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Add shadow to logo */
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            animation: slideIn 1s ease-out;
        }

        .company-name {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            animation: slideIn 1s ease-out 0.2s both;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* Subtle text shadow */
        }

        .tagline {
            color: #666;
            font-size: 16px;
            animation: slideIn 1s ease-out 0.4s both;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
            background-color: #fdfdff; /* Slightly off-white background */
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); /* Focus glow effect */
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2); /* Initial shadow for buttons */
        }

        .btn:hover {
            transform: translateY(-3px); /* Slightly more pronounced lift */
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4); /* Stronger shadow on hover */
            background: linear-gradient(45deg, #5a6fd8, #6a3ea0); /* Darker gradient on hover */
        }

        .btn-secondary {
            background: #6c757d;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }

        .btn-secondary:hover {
            box-shadow: 0 12px 30px rgba(108, 117, 125, 0.4);
            background: #5a6268;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            margin-left: 15px;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.4);
            background: linear-gradient(45deg, #c82333, #b01f2b);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1); /* Subtle shadow */
        }

        .upload-area:hover {
            background: #eef2ff;
            border-color: #5a6fd8;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2); /* Enhanced shadow on hover */
        }

        .upload-area.dragover {
            background: #e6edff;
            border-color: #4c63d2;
            transform: scale(1.02);
        }

        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee; /* Separator for file list */
            padding-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Small shadow for list items */
        }

        .candidate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .candidate-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6edff 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle border for cards */
        }

        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .candidate-avatar {
            background: linear-gradient(to right, #667eea, #764ba2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .candidate-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
        }

        .candidate-skills {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .match-score {
            background: linear-gradient(to right, #28a745, #20c997);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }

        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9); /* Slightly transparent */
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .skip-animation {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 25px;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Logout Button Styles */
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .logout-btn::before {
            content: "üö™";
            font-size: 16px;
        }

        /* User Info Display */
        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .user-info.show {
            display: block;
        }

        /* Confirmation Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Darker overlay */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px); /* Blur background */
            -webkit-backdrop-filter: blur(3px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25); /* Stronger shadow */
            animation: modalFadeIn 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .modal-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn-confirm {
            background: #dc3545;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9); /* More opaque */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .loading-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #667eea; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }

        /* New Modal for Resume View */
        .resume-view-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7); /* Darker overlay */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .resume-view-modal-overlay.active {
            display: flex;
        }

        .resume-view-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); /* Stronger shadow */
            animation: modalFadeIn 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .resume-view-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .resume-view-modal-header h3 {
            margin: 0;
            color: #333;
        }

        .resume-view-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
        }
        .resume-view-modal-close:hover {
            color: #333;
        }

        .resume-view-modal-body {
            flex-grow: 1;
            overflow-y: auto;
            white-space: pre-wrap; /* Preserves whitespace and wraps text */
            font-family: 'Roboto Mono', monospace; /* More modern monospace font */
            font-size: 14px;
            line-height: 1.6;
            color: #444;
            padding-right: 10px; /* For scrollbar */
        }

        /* Password validation styles */
        .password-requirements {
            margin-top: 10px;
            font-size: 13px;
            list-style: none;
            padding-left: 0;
        }

        .password-requirements li {
            color: #dc3545; /* Red for not satisfied */
            margin-bottom: 5px;
            position: relative;
            padding-left: 20px; /* Space for the tick/cross */
        }

        .password-requirements li::before {
            content: '‚úñ'; /* Default cross mark */
            color: #dc3545; /* Red for not satisfied */
            position: absolute;
            left: 0;
            top: 0;
        }

        .password-requirements li.satisfied {
            color: #28a745; /* Green for satisfied */
        }

        .password-requirements li.satisfied::before {
            content: '‚úî'; /* Green tick mark */
            color: #28a745; /* Green for satisfied */
        }


        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 0;
            }

            .page {
                padding: 30px 20px;
                padding-top: 70px; /* Account for logout button on mobile */
                border-radius: 10px; /* Smaller border-radius on mobile */
            }

            .candidate-grid {
                grid-template-columns: 1fr;
            }

            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .logout-btn {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }

            .user-info {
                top: 10px;
                left: 10px;
                font-size: 12px;
                padding: 6px 12px;
            }
            .dashboard-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .dashboard-filters .form-group {
                min-width: unset;
                width: 100%;
            }
            .dashboard-filters .btn {
                width: 100%;
            }
        }

        /* Dashboard Filters */
        .dashboard-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: flex-end;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8); /* Slightly transparent background for filters */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dashboard-filters .form-group {
            margin-bottom: 0; /* Override default form-group margin */
            flex: 1;
            min-width: 150px;
        }

        .dashboard-filters .form-group label {
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        .dashboard-filters .form-group input,
        .dashboard-filters .form-group select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            background-color: #fdfdff;
            border: 1px solid #ddd;
        }
        .dashboard-filters .form-group input:focus,
        .dashboard-filters .form-group select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }

        .dashboard-filters .btn {
            padding: 10px 20px;
            font-size: 14px;
            min-width: 100px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }
        .dashboard-filters .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
    </style>
    <!-- Optional: Google Fonts for a nicer monospace font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Skip Animation Button (only on landing page) -->
        <button class="skip-animation" id="skipBtn" onclick="skipToAuth()">Skip Animation</button>

        <!-- Page 1: Landing/Branding -->
        <div class="page active" id="landing">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
                <div class="tagline">Curating Talent. Creating Eras</div>
            </div>
        </div>

        <!-- Page 2: Sign Up / Sign In Choice -->
        <div class="page" id="auth">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
                <div class="tagline">Welcome Back</div>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Get Started</h2>
                <p>Choose an option to continue</p>
            </div>

            <div style="display: flex; gap: 20px; justify-content: center;">
                <button class="btn" onclick="goToPage('signup')" style="flex: 1;">Sign Up</button>
                <button class="btn" onclick="goToPage('signin')" style="flex: 1;">Sign In</button>
            </div>
        </div>

        <!-- Page 3: Sign Up -->
        <div class="page" id="signup">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <h2 style="text-align: center; margin-bottom: 30px;">Create Account</h2>

            <div class="form-group">
                <label for="signupEmail">Email Address</label>
                <input type="email" id="signupEmail" placeholder="Enter your email address">
                <div class="error-message" id="signupEmailError"></div>
            </div>

            <div class="form-group">
                <label for="signupPhone">Phone Number (Optional)</label>
                <input type="tel" id="signupPhone" placeholder="Enter your phone number">
                <div class="error-message" id="signupPhoneError"></div>
            </div>

            <div class="form-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="Create a password" onkeyup="updatePasswordRequirements('signupPassword', 'signupPasswordRequirements')">
                <ul class="password-requirements" id="signupPasswordRequirements">
                    <li id="signupLength">At least 8 characters</li>
                    <li id="signupCapital">At least one capital letter</li>
                    <li id="signupSmall">At least one small letter</li>
                    <li id="signupNumber">At least one number</li>
                    <li id="signupSymbol">At least one special symbol</li>
                </ul>
                <div class="error-message" id="signupPasswordError"></div>
            </div>

            <div class="form-group">
                <label for="signupConfirmPassword">Confirm Password</label>
                <input type="password" id="signupConfirmPassword" placeholder="Confirm your password">
                <div class="error-message" id="signupConfirmPasswordError"></div>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('auth')">Back</button>
                <button class="btn" onclick="handleSignup()">Create Account</button>
            </div>
        </div>

        <!-- Page 4: Sign In -->
        <div class="page" id="signin">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <h2 style="text-align: center; margin-bottom: 30px;">Sign In</h2>

            <div class="form-group">
                <label for="signinEmail">Email Address</label>
                <input type="email" id="signinEmail" placeholder="Enter your email address">
                <div class="error-message" id="signinEmailError"></div>
            </div>

            <div class="form-group">
                <label for="signinPassword">Password</label>
                <input type="password" id="signinPassword" placeholder="Enter your password">
                <div class="error-message" id="signinPasswordError"></div>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('auth')">Back</button>
                <button class="btn btn-secondary" onclick="forgotPassword()">Forgot Password?</button>
                <button class="btn" onclick="handleSignin()">Sign In</button>
            </div>
        </div>

        <!-- Page for OTP Verification -->
        <div class="page" id="otpVerification">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px;">Verify OTP</h2>
            <p style="text-align: center; margin-bottom: 20px;">An OTP has been sent to <span id="otpEmailDisplay" style="font-weight: bold;"></span>. Please enter it below.</p>
            <div class="form-group">
                <label for="otpInput">OTP</label>
                <input type="text" id="otpInput" placeholder="Enter 6-digit OTP">
                <div class="error-message" id="otpError"></div>
            </div>
            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('signin')">Back to Sign In</button>
                <button class="btn" onclick="verifyOtp()">Verify OTP</button>
            </div>
        </div>

        <!-- Page for Password Reset -->
        <div class="page" id="resetPassword">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px;">Reset Password</h2>
            <p style="text-align: center; margin-bottom: 20px;">Enter your new password for <span id="resetEmailDisplay" style="font-weight: bold;"></span>.</p>
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password" onkeyup="updatePasswordRequirements('newPassword', 'resetPasswordRequirements')">
                <ul class="password-requirements" id="resetPasswordRequirements">
                    <li id="resetLength">At least 8 characters</li>
                    <li id="resetCapital">At least one capital letter</li>
                    <li id="resetSmall">At least one small letter</li>
                    <li id="resetNumber">At least one number</li>
                    <li id="resetSymbol">At least one special symbol</li>
                </ul>
                <div class="error-message" id="newPasswordError"></div>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                <div class="error-message" id="confirmNewPasswordError"></div>
            </div>
            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('signin')">Cancel</button>
                <button class="btn" onclick="handlePasswordReset()">Reset Password</button>
            </div>
        </div>


        <!-- Page 5: HR Information -->
        <div class="page" id="hrInfo">
            <!-- User Info Display -->
            <div class="user-info" id="userInfo"></div>
            <!-- Logout Button -->
            <button class="logout-btn" onclick="showLogoutConfirmation()">Logout</button>

            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 20%"></div>
            </div>

            <div class="form-group">
                <label for="hrName">Full Name</label>
                <input type="text" id="hrName" placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label for="hrId">HR ID</label>
                <input type="text" id="hrId" placeholder="Enter your HR ID">
            </div >

            <div class="form-group">
                <label for="position">Position</labeL>
                <input type="text" id="position" placeholder="e.g., Senior HR Manager">
            </div >

            <div class="form-group">
                <label for="department">Department</label>
                <select id="department">
                    <option value="">Select Department</option>
                    <option value="Human Resources">Human Resources</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Finance">Finance</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Operations">Operations</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('signin')">Back</button>
                <button class="btn" onclick="saveHrInfoAndGoToJobDescription()">Next</button>
            </div>
        </div>

        <!-- Page 6: Job Description / Keywords -->
        <div class="page" id="jobDescription">
            <!-- User Info Display -->
            <div class="user-info" id="userInfo2"></div>
            <!-- Logout Button -->
            <button class="logout-btn" onclick="showLogoutConfirmation()">Logout</button>

            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 40%"></div>
            </div>

            <div class="form-group">
                <label for="jobTitle">Job Title</label>
                <input type="text" id="jobTitle" placeholder="e.g., Senior Software Engineer">
            </div>

            <div class="form-group">
                <label for="jobDesc">Job Description</label>
                <textarea id="jobDesc" placeholder="Paste or type the complete job description here..."></textarea>
            </div>

            <div class="form-group">
                <label for="keywordInput">Keywords/Skills (Press Enter to add)</label>
                <input type="text" id="keywordInput" placeholder="e.g., JavaScript, React, Node.js" onkeypress="handleKeywordInput(event)">
                <div class="tags-input" id="keywordTags"></div>
            </div>

            <div class="form-group">
                <label for="experience">Years of Experience Required</label>
                <select id="experience">
                    <option value="Any">Any</option>
                    <option value="0-2">0-2 years</option>
                    <option value="3-5">3-5 years</option>
                    <option value="6-10">6-10 years</option>
                    <option value="10+">10+ years</option>
                </select>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('hrInfo')">Back</button>
                <button class="btn" onclick="saveJobRequirementsAndGoToUpload()">Next</button>
            </div>
        </div>

        <!-- Page 7: Resume Upload -->
        <div class="page" id="upload">
            <!-- User Info Display -->
            <div class="user-info" id="userInfo3"></div>
            <!-- Logout Button -->
            <button class="logout-btn" onclick="showLogoutConfirmation()">Logout</button>

            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 60%"></div>
            </div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                <h3>Drop files here or click to upload</h3>
                <p>Supports PDF, DOC, DOCX files (Max 1000 files)</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
            </div>

            <div class="file-list" id="fileList"></div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('jobDescription')">Back</button>
                <button class="btn" onclick="uploadResumesAndGoToTopN()" id="uploadNext" disabled>Next</button>
            </div>
        </div>

        <!-- Page 8: Top N Selection -->
        <div class="page" id="topN">
            <!-- User Info Display -->
            <div class="user-info" id="userInfo4"></div>
            <!-- Logout Button -->
            <button class="logout-btn" onclick="showLogoutConfirmation()">Logout</button>

            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 80%"></div>
            </div>

            <div class="form-group">
                <label for="topCandidates">Number of Top Candidates to Shortlist</label>
                <input type="number" id="topCandidates" placeholder="e.g., 10" min="1" max="100" value="10">
            </div>

            <div class="form-group">
                <label for="location">Location Filter (Optional)</label>
                <input type="text" id="location" placeholder="e.g., New York, Remote">
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage('upload')">Back</button>
                <button class="btn" onclick="processResumes()">Process Resumes</button>
            </div>
        </div>

        <!-- Page 9: Result Dashboard -->
        <div class="page" id="dashboard">
            <!-- User Info Display -->
            <div class="user-info" id="userInfo5"></div>
            <!-- Logout Button -->
            <button class="logout-btn" onclick="showLogoutConfirmation()">Logout</button>

            <div class="logo-container">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="EpochFolio Logo" class="logo-img" />
                <div class="company-name">EpochFolio</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>

            <div class="dashboard-header">
                <h2>Screening Results</h2>
                <p>Top candidates based on your criteria</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUploaded">0</div>
                    <div class="stat-label">Total Resumes Uploaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="shortlistedCount">0</div>
                    <div class="stat-label">Shortlisted Candidates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgShortlistedScore">0%</div>
                    <div class="stat-label">Avg Shortlisted Score</div>
                </div>
            </div>

            <div class="dashboard-filters">
                <div class="form-group">
                    <label for="filterCategory">Filter by Category:</label>
                    <select id="filterCategory" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        <option value="Tech">Tech</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Design">Design</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">HR</option>
                        <option value="Sales">Sales</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Operations">Operations</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Customer Service">Customer Service</option>
                        <option value="Legal">Legal</option>
                        <option value="Project Management">Project Management</option>
                        <option value="Social Media">Social Media</option>
                        <option value="Other">Other</option>
                        <option value="Uncategorized">Uncategorized</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="minScore">Min Score:</label>
                    <input type="number" id="minScore" min="0" max="100" value="0" onchange="applyFilters()">
                </div>
                <div class="form-group">
                    <label for="maxScore">Max Score:</label>
                    <input type="number" id="maxScore" min="0" max="100" value="100" onchange="applyFilters()">
                </div>
                <button class="btn" onclick="applyFilters()">Apply Filters</button>
            </div>

            <div class="navigation" style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="showAllCandidates()" id="showAllBtn">Show All Resumes</button>
                <button class="btn btn-secondary" onclick="downloadFilteredResumes()">Download All Filtered Resumes</button>
                <button class="btn" onclick="restartProcess()">New Screening</button>
            </div>

            <div class="candidate-grid" id="candidateGrid"></div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal-content">
            <h3>Confirm Logout</h3>
            <p>Are you sure you want to logout? Any unsaved progress will be lost.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideLogoutConfirmation()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Resume View Modal -->
    <div class="resume-view-modal-overlay" id="resumeViewModal">
        <div class="resume-view-modal-content">
            <div class="resume-view-modal-header">
                <h3 id="resumeViewModalTitle">Resume Content</h3>
                <button class="resume-view-modal-close" onclick="hideResumeViewModal()">&times;</button>
            </div>
            <div class="resume-view-modal-body" id="resumeViewModalBody">
                <!-- Resume raw text will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Processing resumes... Please wait.</div>
    </div>

    <script>
        // Base URL for your Flask backend
        const API_BASE_URL = window.location.origin + '/api'; // Dynamically get base URL for Render deployment

        // Application state
        let currentPage = 'landing';
        let uploadedFiles = []; // Stores File objects directly
        let uploadedResumeIds = []; // Stores IDs returned from backend after upload
        let keywords = [];
        let candidates = []; // Stores processed candidate data from backend (all screened)
        let displayedCandidates = []; // Stores candidates currently displayed (top N or all)
        let showingAll = false;
        let currentUser = null; // Stores current user info { email, user_id, name, role, hr_id, department, position }
        let currentJobId = null; // Stores the job_id returned from backend
        let otpAction = null; // 'signup' or 'reset_password'

        // Get references to the resume view modal elements
        const resumeViewModal = document.getElementById('resumeViewModal');
        const resumeViewModalTitle = document.getElementById('resumeViewModalTitle');
        const resumeViewModalBody = document.getElementById('resumeViewModalBody');


        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadUserSession(); // Attempt to load user session on startup
            updateUserInfoDisplay(); // Initialize user info display

            let skipClicked = false; // Flag to track if skip is clicked
            document.getElementById('skipBtn').addEventListener('click', () => {
                skipClicked = true;
                goToPage('auth'); // Ensure this function is defined
                document.getElementById('skipBtn').style.display = 'none'; // Hide button
            });

            // Add this block to automatically transition after 3 seconds
            setTimeout(() => {
                // Only transition if still on the landing page and no user is logged in
                if (currentPage === 'landing' && !currentUser && !skipClicked) {
                    goToPage('auth');
                    document.getElementById('skipBtn').style.display = 'none'; // Hide skip button after auto-transition
                }
            }, 3000); // 3000 milliseconds = 3 seconds
        });


        function setupEventListeners() {
            const uploadArea = document.querySelector('.upload-area');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileUpload(e);
            });
        }

        function showLoadingOverlay(message = "Processing...") {
            document.getElementById('loadingOverlay').classList.add('show');
            document.querySelector('.loading-text').textContent = message;
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function skipToAuth() {
            goToPage('auth');
            document.getElementById('skipBtn').style.display = 'none'; // Hide skip button after it's clicked
        }

        function goToPage(pageId) {
            document.getElementById(currentPage).classList.remove('active');
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;

            // Hide skip button on all pages except landing
            const skipBtn = document.getElementById('skipBtn');
            if (pageId !== 'landing') {
                skipBtn.style.display = 'none';
            } else {
                // Ensure skip button is visible if we somehow return to landing
                skipBtn.style.display = 'block';
            }
            updateUserInfoDisplay(); // Update user info display on page change
            // Pre-fill HR info fields if currentUser data exists
            if (pageId === 'hrInfo' && currentUser) {
                document.getElementById('hrName').value = currentUser.name || '';
                document.getElementById('hrId').value = currentUser.hr_id || '';
                document.getElementById('position').value = currentUser.position || '';
                document.getElementById('department').value = currentUser.department || '';
            }
        }

        // Function to validate password strength and update UI
        function updatePasswordRequirements(passwordInputId, requirementsListId) {
            const password = document.getElementById(passwordInputId).value;
            const requirementsList = document.getElementById(requirementsListId);

            // Get all list items within the requirements list
            const requirementItems = requirementsList.querySelectorAll('li');

            // Check each requirement and update the UI accordingly
            const hasLength = password.length >= 8;
            const hasCapital = /[A-Z]/.test(password);
            const hasSmall = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

            // Update each requirement item based on the password check
            requirementItems[0].classList.toggle('satisfied', hasLength);
            requirementItems[1].classList.toggle('satisfied', hasCapital);
            requirementItems[2].classList.toggle('satisfied', hasSmall);
            requirementItems[3].classList.toggle('satisfied', hasNumber);
            requirementItems[4].classList.toggle('satisfied', hasSymbol);
        }

        function validatePassword(password) {
            const hasLength = password.length >= 8;
            const hasCapital = /[A-Z]/.test(password);
            const hasSmall = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            return hasLength && hasCapital && hasSmall && hasNumber && hasSymbol;
        }


        async function handleSignup() {
            const email = document.getElementById('signupEmail').value;
            const phone = document.getElementById('signupPhone').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            // Clear errors
            document.getElementById('signupEmailError').textContent = '';
            document.getElementById('signupPhoneError').textContent = '';
            document.getElementById('signupPasswordError').textContent = '';
            document.getElementById('signupConfirmPasswordError').textContent = '';

            if (!email) {
                document.getElementById('signupEmailError').textContent = 'Email is required';
                return;
            }
            if (!password) {
                document.getElementById('signupPasswordError').textContent = 'Password is required';
                return;
            }
            if (!validatePassword(password)) {
                document.getElementById('signupPasswordError').textContent = 'Password does not meet all requirements.';
                return;
            }
            if (password !== confirmPassword) {
                document.getElementById('signupConfirmPasswordError').textContent = 'Passwords do not match';
                return;
            }

            showLoadingOverlay("Creating account and sending OTP...");

            try {
                const response = await fetch(`${API_BASE_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, phone, password })
                });

                const data = await response.json();
                if (!response.ok) {
                    document.getElementById('signupEmailError').textContent = data.message || 'Signup failed.';
                    return;
                }

                alert(data.message);
                currentUser = { email: email, user_id: data.user_id, name: email.split('@')[0] };
                otpAction = 'signup';
                document.getElementById('otpEmailDisplay').textContent = email;
                goToPage('otpVerification');

            } catch (error) {
                console.error('Signup error:', error);
                alert('An error occurred during signup. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function handleSignin() {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const emailError = document.getElementById('signinEmailError');
            const passwordError = document.getElementById('signinPasswordError');

            // Clear previous errors
            emailError.textContent = '';
            passwordError.textContent = '';

            if (!email) {
                emailError.textContent = 'Please enter your email address';
                return;
            }
            if (!password) {
                passwordError.textContent = 'Please enter your password';
                return;
            }

            showLoadingOverlay("Signing in...");

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    currentUser = {
                        email: data.email,
                        user_id: data.user_id,
                        name: data.name,
                        role: data.role,
                        hr_id: data.hr_id,
                        department: data.department,
                        position: data.position
                    };
                    saveUserSession();
                    alert(data.message);
                    if (data.role_set) {
                        goToPage('jobDescription');
                    } else {
                        goToPage('hrInfo');
                    }
                } else {
                    emailError.textContent = data.message || 'Login failed.';
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function verifyOtp() {
            const email = currentUser ? currentUser.email : document.getElementById('signinEmail').value;
            const otp = document.getElementById('otpInput').value;
            const otpError = document.getElementById('otpError');
            otpError.textContent = '';

            if (!otp) {
                otpError.textContent = 'Please enter the OTP.';
                return;
            }

            showLoadingOverlay("Verifying OTP...");

            try {
                const response = await fetch(`${API_BASE_URL}/verify_otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, action: otpAction })
                });
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    if (otpAction === 'signup') {
                        currentUser = {
                            email: data.email,
                            user_id: data.user_id,
                            name: data.name,
                            role: data.role,
                            hr_id: data.hr_id,
                            department: data.department,
                            position: data.position
                        };
                        saveUserSession();
                        if (data.role_set) {
                            goToPage('jobDescription');
                        } else {
                            goToPage('hrInfo');
                        }
                    } else if (otpAction === 'reset_password') {
                        document.getElementById('resetEmailDisplay').textContent = email;
                        goToPage('resetPassword');
                    }
                    otpAction = null;
                } else {
                    otpError.textContent = data.message || 'OTP verification failed.';
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                alert('An error occurred during OTP verification. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function forgotPassword() {
            const email = document.getElementById('signinEmail').value;
            if (!email) {
                alert('Please enter your email address to reset password.');
                return;
            }

            showLoadingOverlay("Sending OTP for password reset...");

            try {
                const response = await fetch(`${API_BASE_URL}/forgot_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();

                if (response.ok) {
                    currentUser = { email: email, user_id: null, name: email.split('@')[0] }; // user_id will be set after OTP verification if needed
                    otpAction = 'reset_password';
                    document.getElementById('otpEmailDisplay').textContent = email;
                    goToPage('otpVerification');
                    alert(data.message);
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function handlePasswordReset() {
            const email = currentUser ? currentUser.email : '';
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            document.getElementById('newPasswordError').textContent = '';
            document.getElementById('confirmNewPasswordError').textContent = '';

            if (!newPassword) {
                document.getElementById('newPasswordError').textContent = 'New password is required.';
                return;
            }
            if (!validatePassword(newPassword)) {
                document.getElementById('newPasswordError').textContent = 'New password does not meet all requirements.';
                return;
            }
            if (newPassword !== confirmNewPassword) {
                document.getElementById('confirmNewPasswordError').textContent = 'Passwords do not match.';
                return;
            }

            showLoadingOverlay("Resetting password...");

            try {
                const response = await fetch(`${API_BASE_URL}/reset_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, new_password: newPassword })
                });
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    clearUserSession();
                    goToPage('signin');
                } else {
                    alert(`Error resetting password: ${data.message}`);
                }
            } catch (error) {
                console.error('Password reset error:', error);
                alert('An error occurred during password reset. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }


        async function saveHrInfoAndGoToJobDescription() {
            if (!currentUser || !currentUser.user_id) {
                alert('User not logged in. Please sign in first.');
                goToPage('signin');
                return;
            }

            const hrName = document.getElementById('hrName').value;
            const hrId = document.getElementById('hrId').value;
            const position = document.getElementById('position').value;
            const department = document.getElementById('department').value;

            if (!hrName || !hrId || !position || !department) {
                alert('Please fill in all HR information fields.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/select_role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        role: 'HR',
                        hr_id: hrId,
                        full_name: hrName,
                        position: position,
                        department: department
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    alert(`Error setting role: ${data.message}`);
                    return;
                }
                // Update currentUser object with new HR info
                currentUser.role = 'HR';
                currentUser.hr_id = hrId;
                currentUser.name = hrName;
                currentUser.position = position;
                currentUser.department = department;
                saveUserSession();
                goToPage('jobDescription');
            } catch (error) {
                console.error('Error saving HR info/setting role:', error);
                alert('Failed to save HR information. Please try again.');
            }
        }

        async function saveJobRequirementsAndGoToUpload() {
            if (!currentUser || !currentUser.user_id) {
                alert('User not logged in. Please sign in first.');
                goToPage('signin');
                return;
            }

            const jobTitle = document.getElementById('jobTitle').value;
            const jobDesc = document.getElementById('jobDesc').value;
            const department = document.getElementById('department').value; // From HR info page
            const experienceRequired = document.getElementById('experience').value; // New field

            if (!jobTitle || !jobDesc || keywords.length === 0) {
                alert('Please provide a Job Title, Job Description, and at least one keyword/skill.');
                return;
            }

            showLoadingOverlay("Saving job requirements...");

            try {
                const response = await fetch(`${API_BASE_URL}/job_requirements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        job_description: jobDesc,
                        department: department,
                        skills: keywords,
                        experience_required: experienceRequired // Pass new field
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    alert('Job requirements saved successfully!');
                    goToPage('upload');
                } else {
                    alert(`Error saving job requirements: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving job requirements:', error);
                alert('An error occurred while saving job requirements. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        function handleKeywordInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const keyword = input.value.trim();

                if (keyword && !keywords.includes(keyword)) {
                    keywords.push(keyword);
                    input.value = '';
                    renderKeywords();
                }
            }
        }

        function renderKeywords() {
            const container = document.getElementById('keywordTags');
            container.innerHTML = keywords.map(keyword =>
                `<div class="tag">
                    ${keyword}
                    <button class="tag-remove" onclick="removeKeyword('${keyword}')">√ó</button>
                </div>`
            ).join('');
        }

        function removeKeyword(keyword) {
            keywords = keywords.filter(k => k !== keyword);
            renderKeywords();
        }

        function handleFileUpload(event) {
            const files = event.target?.files || event.dataTransfer?.files;
            if (!files) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (uploadedFiles.length >= 1000) {
                    alert('Maximum 1000 files allowed');
                    break;
                }

                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.pdf') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                    uploadedFiles.push(file);
                } else {
                    alert(`Unsupported file type: ${file.name}. Only PDF, DOC, DOCX are allowed.`);
                }
            }

            renderFileList();
            document.getElementById('uploadNext').disabled = uploadedFiles.length === 0;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderFileList();
            document.getElementById('uploadNext').disabled = uploadedFiles.length === 0;
        }

        function renderFileList() {
            const container = document.getElementById('fileList');
            container.innerHTML = uploadedFiles.map((file, index) =>
                `<div class="file-item">
                    <span>${file.name} (${formatFileSize(file.size)})</span>
                    <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Remove</button>
                </div>`
            ).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadResumesAndGoToTopN() {
            if (uploadedFiles.length === 0) {
                alert('Please upload at least one resume.');
                return;
            }

            showLoadingOverlay("Uploading and processing resumes...");

            const formData = new FormData();
            uploadedFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await fetch(`${API_BASE_URL}/upload_resumes`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    uploadedResumeIds = data.resume_ids;
                    alert('Resumes uploaded and processed successfully!');
                    goToPage('topN');
                } else {
                    alert(`Error uploading resumes: ${data.message}`);
                }
            } catch (error) {
                console.error('Error uploading resumes:', error);
                alert('An error occurred during resume upload. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function processResumes() {
            if (!currentJobId || uploadedResumeIds.length === 0) {
                alert('Please ensure job requirements are saved and resumes are uploaded.');
                return;
            }

            showLoadingOverlay("Screening resumes and calculating scores...");

            const topN = parseInt(document.getElementById('topCandidates').value) || 10;
            const locationFilter = document.getElementById('location').value; // Not used in backend yet, but good to capture

            try {
                const response = await fetch(`${API_BASE_URL}/screen_resumes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        resume_ids: uploadedResumeIds
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    candidates = data.results;
                    candidates.sort((a, b) => b.match_score - a.match_score);

                    applyFilters(); // Apply filters immediately after processing

                    document.getElementById('totalUploaded').textContent = uploadedFiles.length;
                    // shortlistedCount and avgShortlistedScore will be updated by applyFilters()

                    goToPage('dashboard');
                } else {
                    alert(`Error screening resumes: ${data.message}`);
                }
            } catch (error) {
                console.error('Error screening resumes:', error);
                alert('An error occurred during resume screening. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        function applyFilters() {
            const filterCategory = document.getElementById('filterCategory').value;
            const minScore = parseInt(document.getElementById('minScore').value);
            const maxScore = parseInt(document.getElementById('maxScore').value);
            const topN = parseInt(document.getElementById('topCandidates').value) || 10;

            let filteredCandidates = candidates.filter(candidate => {
                const meetsCategory = filterCategory === "" || candidate.categorized_field === filterCategory; // Corrected field name
                const meetsMinScore = candidate.match_score >= minScore;
                const meetsMaxScore = candidate.match_score <= maxScore;
                return meetsCategory && meetsMinScore && meetsMaxScore;
            });

            // Sort by score descending
            filteredCandidates.sort((a, b) => b.match_score - a.match_score);

            // If not showing all, slice to top N after filtering
            displayedCandidates = showingAll ? filteredCandidates : filteredCandidates.slice(0, topN);

            renderCandidates();
        }


        function renderCandidates() {
            const container = document.getElementById('candidateGrid');
            const topN = parseInt(document.getElementById('topCandidates').value) || 10;

            container.innerHTML = displayedCandidates.map(candidate =>
                `<div class="candidate-card">
                    <div class="candidate-avatar">${candidate.filename.charAt(0).toUpperCase()}</div>
                    <div class="candidate-name">${candidate.filename.split('.')[0]}</div>
                    <div class="candidate-skills">${candidate.matched_skills.join(', ') || 'No skills matched'}</div>
                    <div style="font-size: 12px; color: #888; margin-top: 5px;">Category: ${candidate.categorized_field || 'Uncategorized'}</div> <!-- Corrected field name and fallback -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div class="match-score">${candidate.match_score}% Match</div>
                        <div>
                            <button class="btn" style="padding: 8px 16px; font-size: 14px; margin-right: 5px;" onclick="viewResume('${candidate.resume_id}', '${candidate.filename}')">View</button>
                            <button class="btn" style="padding: 8px 16px; font-size: 14px;" onclick="downloadResume('${candidate.resume_id}', '${candidate.filename}')">Download</button>
                        </div>
                    </div>
                </div>`
            ).join('');

            document.getElementById('shortlistedCount').textContent = displayedCandidates.length;
            const totalScore = displayedCandidates.reduce((sum, c) => sum + c.match_score, 0);
            const avgScore = displayedCandidates.length > 0 ? Math.round(totalScore / displayedCandidates.length) : 0;
            document.getElementById('avgShortlistedScore').textContent = avgScore + '%';

            const showAllBtn = document.getElementById('showAllBtn');
            if (candidates.length > topN) {
                showAllBtn.style.display = 'inline-block';
                showAllBtn.textContent = showingAll ? 'Show Top ' + topN + ' Candidates' : 'Show All Resumes (' + candidates.length + ')';
            } else {
                showAllBtn.style.display = 'none';
            }
        }

        function showAllCandidates() {
            showingAll = !showingAll;
            applyFilters(); // Re-apply filters to update displayedCandidates based on showingAll
        }

        async function viewResume(resumeId, filename) {
            resumeViewModalTitle.textContent = `${filename.split('.')[0]} - Resume Content`;
            resumeViewModalBody.innerHTML = '<div class="loading">Loading resume...<div class="spinner"></div></div>';

            try {
                // Find the resume data in the local 'candidates' array first
                const candidateData = candidates.find(c => c.resume_id === resumeId);
                if (candidateData && candidateData.raw_text) {
                    resumeViewModalBody.textContent = candidateData.raw_text;
                    console.log("Resume loaded from local cache.");
                } else {
                    // If not in local cache, fetch from backend
                    const response = await fetch(`${API_BASE_URL}/resume_raw_text/${resumeId}`);
                    const data = await response.json();

                    if (response.ok) {
                        resumeViewModalBody.textContent = data.raw_text;
                        console.log("Resume loaded from backend.");
                        // Optionally, update local cache if fetched from backend
                        if (candidateData) {
                            candidateData.raw_text = data.raw_text;
                        }
                    } else {
                        resumeViewModalBody.innerHTML = `<div class="error-message">Failed to load resume content: ${data.message || 'Unknown error'}</div>`;
                        console.error("Error loading resume:", data);
                    }
                }
            } catch (error) {
                console.error("Error fetching raw text:", error);
                resumeViewModalBody.innerHTML = `<div class="error-message">Network error or backend not reachable.</div>`;
            } finally {
                resumeViewModal.classList.add("active");
                document.body.style.overflow = "hidden";
            }
        }

        function hideResumeViewModal() {
            resumeViewModal.classList.remove("active");
            document.body.style.overflow = "auto";
        }

        function downloadResume(resumeId, filename) {
            const downloadUrl = `${API_BASE_URL}/download_resume/${resumeId}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log(`Downloading ${filename}...`);
        }

        async function downloadFilteredResumes() {
            if (displayedCandidates.length === 0) {
                alert('No filtered resumes to download.');
                return;
            }

            showLoadingOverlay("Preparing filtered resumes for download...");

            const filteredResumeIds = displayedCandidates.map(candidate => candidate.resume_id);

            try {
                const response = await fetch(`${API_BASE_URL}/download_all_filtered_resumes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filtered_resume_ids: filteredResumeIds })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'filtered_resumes.zip';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    alert('All filtered resumes downloaded as a ZIP file.');
                    console.log("Filtered resumes downloaded successfully.");
                } else {
                    const errorData = await response.json();
                    alert(`Error downloading filtered resumes: ${errorData.message || response.statusText}`);
                    console.error("Error downloading filtered resumes:", errorData);
                }
            } catch (error) {
                console.error('Error downloading filtered resumes:', error);
                alert('An error occurred while trying to download filtered resumes. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }

        function showLogoutConfirmation() {
            document.getElementById('logoutModal').classList.add('show');
        }

        function hideLogoutConfirmation() {
            document.getElementById('logoutModal').classList.remove('show');
        }

        // NEW FUNCTION: Handles the actual logout process
        function confirmLogout() {
            hideLogoutConfirmation(); // Hide the modal first
            clearUserSession(); // Clear user data from local storage and currentUser variable
            resetApplicationState(); // Reset all frontend state variables and UI elements
            goToPage('auth'); // Redirect to the authentication page
            alert('You have been successfully logged out.');
        }

        function saveUserSession() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserInfoDisplay();
            }
        }

        function loadUserSession() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
            }
        }

        function clearUserSession() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            updateUserInfoDisplay();
            clearUserInfo();
        }

        function updateUserInfoDisplay() {
            const userInfoElements = document.querySelectorAll('.user-info');
            userInfoElements.forEach(el => {
                if (currentUser && currentUser.name) {
                    el.textContent = `Welcome, ${currentUser.name}`;
                    el.classList.add('show');
                } else {
                    el.textContent = '';
                    el.classList.remove('show');
                }
            });
        }

        function clearUserInfo() {
            const userInfoElements = document.querySelectorAll('.user-info');
            userInfoElements.forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
        }

        function resetApplicationState() {
            uploadedFiles = [];
            uploadedResumeIds = [];
            keywords = [];
            candidates = [];
            displayedCandidates = [];
            showingAll = false;
            currentJobId = null;
            // Do NOT clear user session here, as clearUserSession() is called separately
            // clearUserSession(); // This line was removed to avoid double-clearing and ensure proper flow

            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPhone').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';
            document.getElementById('signinEmail').value = '';
            document.getElementById('signinPassword').value = '';
            document.getElementById('hrName').value = '';
            document.getElementById('hrId').value = '';
            document.getElementById('position').value = '';
            document.getElementById('department').value = '';
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobDesc').value = '';
            document.getElementById('keywordInput').value = '';
            document.getElementById('topCandidates').value = '10';
            document.getElementById('location').value = '';
            document.getElementById('otpInput').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('experience').value = 'Any'; // Reset experience

            const passwordRequirementLists = document.querySelectorAll('.password-requirements');
            passwordRequirementLists.forEach(list => {
                list.querySelectorAll('li').forEach(li => {
                    li.classList.remove('satisfied');
                });
            });


            document.getElementById('signupEmailError').textContent = '';
            document.getElementById('signupPhoneError').textContent = '';
            document.getElementById('signupPasswordError').textContent = '';
            document.getElementById('signupConfirmPasswordError').textContent = '';
            document.getElementById('signinEmailError').textContent = '';
            document.getElementById('signinPasswordError').textContent = '';
            document.getElementById('otpError').textContent = '';
            document.getElementById('newPasswordError').textContent = '';
            document.getElementById('confirmNewPasswordError').textContent = '';
            document.getElementById('keywordTags').innerHTML = '';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('uploadNext').disabled = true;
            document.getElementById('candidateGrid').innerHTML = '';
            document.getElementById('totalUploaded').textContent = '0';
            document.getElementById('shortlistedCount').textContent = '0';
            document.getElementById('avgShortlistedScore').textContent = '0%';
            document.getElementById('showAllBtn').style.display = 'none';

            // Reset dashboard filters
            document.getElementById('filterCategory').value = '';
            document.getElementById('minScore').value = '0';
            document.getElementById('maxScore').value = '100';
        }

        async function restartProcess() {
            showLoadingOverlay("Starting new screening session...");
            try {
                // Clear backend session data
                const response = await fetch(`${API_BASE_URL}/clear_session_data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    console.error("Failed to clear backend session data:", await response.json());
                    alert("Failed to clear previous session data. Please try again.");
                    hideLoadingOverlay();
                    return;
                }
                console.log("Backend session data cleared successfully.");

                // Clear frontend state variables
                uploadedFiles = [];
                uploadedResumeIds = []; // Crucial to clear this
                keywords = [];
                candidates = [];
                displayedCandidates = [];
                showingAll = false;
                currentJobId = null;

                // Reset UI elements
                document.getElementById('jobTitle').value = '';
                document.getElementById('jobDesc').value = '';
                document.getElementById('keywordInput').value = '';
                document.getElementById('keywordTags').innerHTML = '';
                document.getElementById('fileInput').value = ''; // Clear file input selection
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('uploadNext').disabled = true;
                document.getElementById('topCandidates').value = '10';
                document.getElementById('location').value = '';
                document.getElementById('candidateGrid').innerHTML = '';
                document.getElementById('totalUploaded').textContent = '0';
                document.getElementById('shortlistedCount').textContent = '0';
                document.getElementById('avgShortlistedScore').textContent = '0%';
                document.getElementById('showAllBtn').style.display = 'none';
                document.getElementById('experience').value = 'Any'; // Reset experience

                // Reset dashboard filters
                document.getElementById('filterCategory').value = '';
                document.getElementById('minScore').value = '0';
                document.getElementById('maxScore').value = '100';


                // Navigate to the job description page
                goToPage('jobDescription');
                alert('New screening process started. All previous session data cleared.');

            } catch (error) {
                console.error('Error during restart process:', error);
                alert('An error occurred while starting a new screening. Please try again.');
            } finally {
                hideLoadingOverlay();
            }
        }
    </script>
</body>
</html>

